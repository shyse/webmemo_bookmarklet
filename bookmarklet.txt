javascript:(function(){const dbName='bookmarkletMemoDB',storeName='memos',overlayId='bookmarklet-memo-overlay';function openDB(){return new Promise((resolve,reject)=>{const req=indexedDB.open(dbName,1);req.onupgradeneeded=e=>{e.target.result.createObjectStore(storeName,{keyPath:'url'})};req.onsuccess=e=>resolve(e.target.result);req.onerror=e=>reject(e.target.error)});}function getMemo(db,url){return new Promise((resolve,reject)=>{const tx=db.transaction([storeName],'readonly'),store=tx.objectStore(storeName);const req=store.get(url);req.onsuccess=e=>resolve(e.target.result||{});req.onerror=e=>reject(e.target.error)});}function saveMemo(db,url,memo,timestampsEl){return new Promise((resolve,reject)=>{const tx=db.transaction([storeName],'readwrite'),store=tx.objectStore(storeName);const now=new Date();const formatJST=(date)=>{const jstOffset=9*60*60*1000;return new Date(date.getTime()+jstOffset).toISOString().replace('T',' ').substring(0,19);};const newData={url,memo,updated:formatJST(now)};store.put(newData);tx.oncomplete=()=>{timestampsEl.textContent=`更新日時: ${newData.updated}`;resolve();};tx.onerror=e=>reject(e.target.error)});}function deleteMemo(db,url,timestampsEl){return new Promise((resolve,reject)=>{const tx=db.transaction([storeName],'readwrite'),store=tx.objectStore(storeName);store.delete(url);tx.oncomplete=()=>{timestampsEl.textContent='更新日時: ---';resolve();};tx.onerror=e=>reject(e.target.error)});}function exportData(db){return new Promise((resolve,reject)=>{const tx=db.transaction([storeName],'readonly'),store=tx.objectStore(storeName);const req=store.getAll();req.onsuccess=e=>resolve(e.target.result||[]);req.onerror=e=>reject(e.target.error)});}function importData(db,data){return new Promise((resolve,reject)=>{const tx=db.transaction([storeName],'readwrite'),store=tx.objectStore(storeName);data.forEach(entry=>store.put(entry));tx.oncomplete=()=>resolve();tx.onerror=e=>reject(e.target.error)});}function createOverlay(data,db){const url=location.origin+location.pathname;const existing=document.getElementById(overlayId);if(existing){existing.remove()}const ov=document.createElement('div');ov.id=overlayId;Object.assign(ov.style,{position:'fixed',top:'50px',right:'30px',width:'400px',height:'400px',backgroundColor:'rgba(255,255,255,0.95)',border:'1px solid #aaa',borderRadius:'8px',boxShadow:'0 4px 8px rgba(0,0,0,0.2)',zIndex:10000,padding:'20px',fontFamily:'Arial,sans-serif',userSelect:'none',boxSizing:'border-box',minWidth:'400px',minHeight:'400px'});const head=document.createElement('div');Object.assign(head.style,{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'15px'});ov.appendChild(head);const title=document.createElement('div');title.textContent='Page Memo';Object.assign(title.style,{fontSize:'20px',fontWeight:'bold',color:'#2c3e50',textShadow:'1px 1px 2px rgba(0,0,0,0.2)'});head.appendChild(title);const close=document.createElement('button');close.textContent='×';Object.assign(close.style,{background:'none',border:'none',color:'#888',cursor:'pointer',fontSize:'18px'});close.onclick=()=>ov.remove();head.appendChild(close);const ta=document.createElement('textarea');Object.assign(ta.style,{width:'100%',height:'calc(100% - 220px)',border:'1px solid #ccc',borderRadius:'4px',padding:'10px',resize:'none',boxSizing:'border-box'});ta.value=data.memo||'';ov.appendChild(ta);const timestamps=document.createElement('div');timestamps.textContent=%60更新日時: ${data.updated||'---'}%60;Object.assign(timestamps.style,{fontSize:'12px',marginTop:'10px',color:'#666'});ov.appendChild(timestamps);const buttons=document.createElement('div');Object.assign(buttons.style,{display:'flex',gap:'10px',marginTop:'15px',justifyContent:'space-between'});ov.appendChild(buttons);const save=document.createElement('button');save.textContent='保存';Object.assign(save.style,{backgroundColor:'#6c7a89',color:'white',border:'none',padding:'10px 15px',borderRadius:'4px',cursor:'pointer',flex:'1'});save.onclick=()=>saveMemo(db,url,ta.value,timestamps).then(()=>{showMessage('メモを保存しました！')});buttons.appendChild(save);const del=document.createElement('button');del.textContent='削除';Object.assign(del.style,{backgroundColor:'#e74c3c',color:'white',border:'none',padding:'10px 15px',borderRadius:'4px',cursor:'pointer',flex:'1'});del.onclick=()=>deleteMemo(db,url,timestamps).then(()=>{ta.value='';timestamps.textContent='更新日時: ---';showMessage('メモを削除しました！')});buttons.appendChild(del);const extra=document.createElement('div');Object.assign(extra.style,{marginTop:'15px',display:'flex',gap:'10px',justifyContent:'space-between'});ov.appendChild(extra);const exp=document.createElement('button');exp.textContent='エクスポート';Object.assign(exp.style,{backgroundColor:'#95a5a6',color:'white',border:'none',padding:'10px 15px',borderRadius:'4px',cursor:'pointer',flex:'1'});exp.onclick=()=>exportData(db).then(data=>{const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='memos.json';a.click()}).catch(err=>showMessage('エクスポートに失敗しました: ' + err.message));extra.appendChild(exp);const imp=document.createElement('button');imp.textContent='インポート';Object.assign(imp.style,{backgroundColor:'#95a5a6',color:'white',border:'none',padding:'10px 15px',borderRadius:'4px',cursor:'pointer',flex:'1'});imp.onclick=()=>{const input=document.createElement('input');input.type='file';input.accept='.json';input.onchange=e=>{const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=ev=>{try{const data=JSON.parse(ev.target.result);importData(db,data).then(()=>showMessage('データをインポートしました！'))}catch(err){showMessage('インポートに失敗しました: '+err.message)}};reader.readAsText(file)}};input.click()};extra.appendChild(imp);const resizeHandle=document.createElement('div');Object.assign(resizeHandle.style,{position:'absolute',bottom:'0',right:'0',width:'12px',height:'12px',borderRight:'2px solid #aaa',borderBottom:'2px solid #aaa',cursor:'se-resize'});resizeHandle.onmousedown=function(e){let startX=e.clientX,startY=e.clientY,startWidth=ov.offsetWidth,startHeight=ov.offsetHeight;document.onmousemove=function(e){let dx=e.clientX-startX,dy=e.clientY-startY;ov.style.width=Math.max(startWidth+dx,400)+'px';ov.style.height=Math.max(startHeight+dy,400)+'px'};document.onmouseup=function(){document.onmousemove=null;document.onmouseup=null}};ov.appendChild(resizeHandle);document.body.appendChild(ov);}function showMessage(message){const msgDiv=document.createElement('div');msgDiv.textContent=message;Object.assign(msgDiv.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',backgroundColor:'#2c3e50',color:'white',padding:'10px 20px',borderRadius:'5px',boxShadow:'0 4px 8px rgba(0,0,0,0.2)',zIndex:10000});document.body.appendChild(msgDiv);setTimeout(()=>msgDiv.remove(),3000);}openDB().then(db=>{const url=location.origin+location.pathname;getMemo(db,url).then(data=>createOverlay(data,db))}).catch(e=>console.error('IndexedDB エラー:',e))})();